<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    

    <title>metaseq.plotutils &mdash; metaseq 0.5.6 documentation</title>

<meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=0;"/>


    
    <link rel="stylesheet" href="../../_static/rtd.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.5.6',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../../_static/searchtools.js"></script>
    <link rel="top" title="metaseq 0.5.6 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">metaseq 0.5.6 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for metaseq.plotutils</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Module with handy utilities for plotting genomic signal</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">mlab</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">matplotlib.ticker</span> <span class="kn">import</span> <span class="n">MaxNLocator</span>
<span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1</span> <span class="kn">import</span> <span class="n">make_axes_locatable</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">gridspec</span>
<span class="kn">import</span> <span class="nn">colormap_adjust</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>


<div class="viewcode-block" id="ci_plot"><a class="viewcode-back" href="../../autodocs/metaseq.plotutils.ci_plot.html#metaseq.plotutils.ci_plot">[docs]</a><span class="k">def</span> <span class="nf">ci_plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">arr</span><span class="p">,</span> <span class="n">conf</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">line_kwargs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">fill_kwargs</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plots the mean and 95% ci for the given array on the given axes</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : 1-D array-like</span>
<span class="sd">        x values for the plot</span>

<span class="sd">    arr : 2-D array-like</span>
<span class="sd">        The array to calculate mean and std for</span>

<span class="sd">    conf : float [.5 - 1]</span>
<span class="sd">        Confidence interval to use</span>

<span class="sd">    ax : matplotlib.Axes</span>
<span class="sd">        The axes object on which to plot</span>

<span class="sd">    line_kwargs : dict</span>
<span class="sd">        Additional kwargs passed to Axes.plot</span>

<span class="sd">    fill_kwargs : dict</span>
<span class="sd">        Additiona kwargs passed to Axes.fill_between</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>

    <span class="n">line_kwargs</span> <span class="o">=</span> <span class="n">line_kwargs</span> <span class="ow">or</span> <span class="p">{}</span>
    <span class="n">fill_kwargs</span> <span class="o">=</span> <span class="n">fill_kwargs</span> <span class="ow">or</span> <span class="p">{}</span>

    <span class="n">m</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span> <span class="o">=</span> <span class="n">ci</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">conf</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="o">**</span><span class="n">line_kwargs</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">,</span> <span class="o">**</span><span class="n">fill_kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ax</span>

</div>
<div class="viewcode-block" id="imshow"><a class="viewcode-back" href="../../autodocs/metaseq.plotutils.imshow.html#metaseq.plotutils.imshow">[docs]</a><span class="k">def</span> <span class="nf">imshow</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">percentile</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
           <span class="n">strip</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">conf</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">sort_by</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
           <span class="n">line_kwargs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">fill_kwargs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">imshow_kwargs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span>
           <span class="n">width_ratios</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">height_ratios</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
           <span class="n">subplot_params</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.1</span><span class="p">),</span>
           <span class="n">subset_by</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">subset_order</span><span class="o">=</span><span class="bp">None</span><span class="p">,):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Do-it-all function to help with plotting heatmaps</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    arr : array-like</span>

<span class="sd">    x : 1D array</span>
<span class="sd">        X values to use.  If None, use range(arr.shape[1])</span>

<span class="sd">    ax : matplotlib.Axes</span>
<span class="sd">        If not None, then only plot the array on the provided axes.  This will</span>
<span class="sd">        ignore any additional arguments provided that apply to figure-level</span>
<span class="sd">        configuration or to the average line plot.  For example, `figsize`,</span>
<span class="sd">        `width_ratios`, `height_ratios`, `subplot_params`, `line_kwargs`, and</span>
<span class="sd">        `fill_kwargs` will all be ignored.</span>

<span class="sd">    vmin, vmax : float</span>

<span class="sd">    percentile : bool</span>
<span class="sd">        If True, then treat values for `vmin` and `vmax` as percentiles rather</span>
<span class="sd">        than absolute values.</span>

<span class="sd">    strip : bool</span>
<span class="sd">        Include a strip plot alongside the array</span>

<span class="sd">    features : pybedtools.BedTool or string filename</span>
<span class="sd">        Features used to construct the array</span>

<span class="sd">    conf : float</span>
<span class="sd">        Confidence interval to use in line plot.</span>

<span class="sd">    sort_by : array-like</span>
<span class="sd">        Use the provided array to sort the array (e.g., an array of expression</span>
<span class="sd">        values).  This array will be argsorted to get the proper order.</span>

<span class="sd">    line_kwargs, fill_kwargs : dict</span>
<span class="sd">        Passed directly to `ci_plot`.</span>

<span class="sd">    figsize : tuple</span>
<span class="sd">        (Width, height) of the figure to create.</span>

<span class="sd">    imshow_kwargs : dict</span>
<span class="sd">        Passed directly to matplotlib.pyplot.imshow.  By default, arguments</span>
<span class="sd">        used are `origin=&#39;lower&#39;`, `aspect=&quot;auto&quot;` and a colormap from</span>
<span class="sd">        colormap_adjust.smart_colormap generated using the provided `vmin` and</span>
<span class="sd">        `vmax`.</span>

<span class="sd">    width_ratios, height_ratios: tuple</span>
<span class="sd">        These tuples are passed to the `new_shell` function.  The default</span>
<span class="sd">        values set up a 2x2 configuration of panels for heatmap, line plot,</span>
<span class="sd">        colorbar axes, and optional strip plot.  However modifying</span>
<span class="sd">        `width_ratios` or `height_ratios` can be used to create more or fewer panels.</span>

<span class="sd">    subplot_params : dict</span>
<span class="sd">        Passed to Figure.subplots_adjust</span>

<span class="sd">    subset_by : array</span>
<span class="sd">        An array of any type (but usually int or str) that contains a class</span>
<span class="sd">        label for each row in the heatmap array.  For example, to subset by</span>
<span class="sd">        expression, an array the values of &quot;up&quot;, &quot;down&quot;, or &quot;unchanged&quot; at each</span>
<span class="sd">        of the positions could be provided.</span>

<span class="sd">        Note that the heatmap array is first sorted by `sort_by` and then split</span>
<span class="sd">        into groups according to `subset_by`, so each subset remains sorted by</span>
<span class="sd">        `sort_by`.</span>

<span class="sd">    subset_order : list-like</span>
<span class="sd">        This provides the order in which the subsets are plotted.  Since the</span>
<span class="sd">        default imshow arguments contain `origin=&quot;lower&quot;`, these will be</span>
<span class="sd">        plotted in order starting at the bottom of the heatmap.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">new_shell</span><span class="p">(</span>
            <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span>
            <span class="n">strip</span><span class="o">=</span><span class="n">strip</span><span class="p">,</span>
            <span class="n">subplot_params</span><span class="o">=</span><span class="n">subplot_params</span><span class="p">,</span>
            <span class="n">width_ratios</span><span class="o">=</span><span class="n">width_ratios</span><span class="p">,</span>
            <span class="n">height_ratios</span><span class="o">=</span><span class="n">height_ratios</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">percentile</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">vmin</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">vmin</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vmin</span> <span class="o">=</span> <span class="n">mlab</span><span class="o">.</span><span class="n">prctile</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">vmin</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">vmax</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">vmax</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vmax</span> <span class="o">=</span> <span class="n">mlab</span><span class="o">.</span><span class="n">prctile</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">vmax</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">vmin</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">vmin</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">vmax</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">vmax</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="n">cmap</span> <span class="o">=</span> <span class="n">colormap_adjust</span><span class="o">.</span><span class="n">smart_colormap</span><span class="p">(</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">)</span>
    <span class="n">_imshow_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">origin</span><span class="o">=</span><span class="s">&#39;lower&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span>
                          <span class="n">aspect</span><span class="o">=</span><span class="s">&#39;auto&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">imshow_kwargs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">_imshow_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">imshow_kwargs</span><span class="p">)</span>

    <span class="c"># previously we did an argsort first; with subsetting we don&#39;t want to do</span>
    <span class="c"># that yet....</span>
    <span class="c">#if sort_by is not None:</span>
    <span class="c">#    ind = np.argsort(sort_by)</span>
    <span class="c">#else:</span>
    <span class="c">#    ind = np.arange(arr.shape[0])</span>

    <span class="k">if</span> <span class="n">sort_by</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">sort_by</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">array_ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">array_axes</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">array_ax</span> <span class="o">=</span> <span class="n">ax</span>

    <span class="c"># If not provided, assume all in the same subset.</span>
    <span class="k">if</span> <span class="n">subset_by</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">subset_by</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c"># Ensure always array, since we&#39;re doing indexing tricks</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subset_by</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">subset_by</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">subset_by</span><span class="p">)</span>

    <span class="c"># If not provided, use sorted order</span>
    <span class="k">if</span> <span class="n">subset_order</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">subset_order</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">subset_by</span><span class="p">))</span>

    <span class="n">inds</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">cls</span> <span class="ow">in</span> <span class="n">subset_order</span><span class="p">:</span>
        <span class="n">subset_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">subset_by</span> <span class="o">==</span> <span class="n">cls</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">subset_sort_by</span> <span class="o">=</span> <span class="n">sort_by</span><span class="p">[</span><span class="n">subset_ind</span><span class="p">]</span>
        <span class="n">subset_argsort_by</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">subset_sort_by</span><span class="p">)</span>
        <span class="n">inds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subset_ind</span><span class="p">[</span><span class="n">subset_argsort_by</span><span class="p">])</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">inds</span><span class="p">)</span>

    <span class="n">mappable</span> <span class="o">=</span> <span class="n">array_ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
        <span class="n">arr</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span> <span class="p">:],</span>
        <span class="n">extent</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
        <span class="o">**</span><span class="n">_imshow_kwargs</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">line_kwargs</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">line_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">fill_kwargs</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">fill_kwargs</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">line_kwargs</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">line_kwargs</span> <span class="o">=</span> <span class="p">[</span><span class="n">line_kwargs</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fill_kwargs</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">fill_kwargs</span> <span class="o">=</span> <span class="p">[</span><span class="n">fill_kwargs</span><span class="p">]</span>

    <span class="n">_line_kwargs</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">cycle</span><span class="p">(</span><span class="n">line_kwargs</span><span class="p">)</span>
    <span class="n">_fill_kwargs</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">cycle</span><span class="p">(</span><span class="n">fill_kwargs</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">mappable</span><span class="p">,</span> <span class="n">fig</span><span class="o">.</span><span class="n">cax</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">subset_ind</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">_lkw</span><span class="p">,</span> <span class="n">_fkw</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">inds</span><span class="p">,</span> <span class="n">subset_order</span><span class="p">,</span> <span class="n">_line_kwargs</span><span class="p">,</span> <span class="n">_fill_kwargs</span><span class="p">):</span>
            <span class="n">ci_plot</span><span class="p">(</span>
                <span class="n">x</span><span class="p">,</span>
                <span class="n">arr</span><span class="p">[</span><span class="n">subset_ind</span><span class="p">],</span>
                <span class="n">ax</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">line_axes</span><span class="p">,</span>
                <span class="n">line_kwargs</span><span class="o">=</span><span class="n">_lkw</span><span class="p">,</span>
                <span class="n">fill_kwargs</span><span class="o">=</span><span class="n">_fkw</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ax</span><span class="o">.</span><span class="n">figure</span>

</div>
<div class="viewcode-block" id="add_labels_to_subsets"><a class="viewcode-back" href="../../autodocs/metaseq.plotutils.add_labels_to_subsets.html#metaseq.plotutils.add_labels_to_subsets">[docs]</a><span class="k">def</span> <span class="nf">add_labels_to_subsets</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">subset_by</span><span class="p">,</span> <span class="n">subset_order</span><span class="p">,</span> <span class="n">text_kwargs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                          <span class="n">add_hlines</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">hline_kwargs</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper function for adding labels to subsets within a heatmap.</span>

<span class="sd">    Assumes that imshow() was called with `subsets` and `subset_order`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ax : matplotlib.Axes</span>
<span class="sd">        The axes to label.  Generally you can use `fig.array_axes` attribute of</span>
<span class="sd">        the Figure object returned by `metaseq.plotutils.imshow`.</span>

<span class="sd">    subset_by, subset_order : array, list</span>
<span class="sd">        See `metaseq.plotutils.imshow()` docstring; these should be the same</span>
<span class="sd">        `subsets` and `subset_order` that were provided to that function.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_text_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">get_yaxis_transform</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">text_kwargs</span><span class="p">:</span>
        <span class="n">_text_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">text_kwargs</span><span class="p">)</span>

    <span class="n">_hline_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;k&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">hline_kwargs</span><span class="p">:</span>
        <span class="n">_hline_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">hline_kwargs</span><span class="p">)</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">subset_order</span><span class="p">:</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">subset_by</span> <span class="o">==</span> <span class="n">label</span>
        <span class="n">last_pos</span> <span class="o">=</span> <span class="n">pos</span>
        <span class="n">pos</span> <span class="o">+=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">add_hlines</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="o">**</span><span class="n">_hline_kwargs</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
            <span class="mf">1.1</span><span class="p">,</span>
            <span class="n">last_pos</span> <span class="o">+</span> <span class="p">(</span><span class="n">pos</span> <span class="o">-</span> <span class="n">last_pos</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span>
            <span class="n">label</span><span class="p">,</span>
            <span class="o">**</span><span class="n">_text_kwargs</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="calculate_limits"><a class="viewcode-back" href="../../autodocs/metaseq.plotutils.calculate_limits.html#metaseq.plotutils.calculate_limits">[docs]</a><span class="k">def</span> <span class="nf">calculate_limits</span><span class="p">(</span><span class="n">array_dict</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s">&#39;global&#39;</span><span class="p">,</span> <span class="n">percentiles</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="p">()):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate limits for a group of arrays in a flexible manner.</span>

<span class="sd">    Returns a dictionary of calculated (vmin, vmax), with the same keys as</span>
<span class="sd">    `array_dict`.</span>

<span class="sd">    Useful for plotting heatmaps of multiple datasets, and the vmin/vmax values</span>
<span class="sd">    of the colormaps need to be matched across all (or a subset) of heatmaps.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    array_dict : dict of np.arrays</span>

<span class="sd">    method : {&#39;global&#39;, &#39;independent&#39;, callable}</span>
<span class="sd">        If method=&quot;global&quot;, then use the global min/max values across all</span>
<span class="sd">        arrays in array_dict.  If method=&quot;independent&quot;, then each array will</span>
<span class="sd">        have its own min/max calcuated.  If a callable, then it will be used to</span>
<span class="sd">        group the keys of `array_dict`, and each group will have its own</span>
<span class="sd">        group-wise min/max calculated.</span>


<span class="sd">    percentiles : None or list</span>
<span class="sd">        If not None, a list of (lower, upper) percentiles in the range [0,100].</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">percentiles</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">percentile</span> <span class="ow">in</span> <span class="n">percentiles</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">percentile</span> <span class="o">&lt;=</span> <span class="mi">100</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;percentile (</span><span class="si">%s</span><span class="s">) not between [0, 100]&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s">&#39;global&#39;</span><span class="p">:</span>
        <span class="n">all_arrays</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
            <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">array_dict</span><span class="o">.</span><span class="n">itervalues</span><span class="p">()]</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">percentiles</span><span class="p">:</span>
            <span class="n">vmin</span> <span class="o">=</span> <span class="n">mlab</span><span class="o">.</span><span class="n">prctile</span><span class="p">(</span>
                <span class="n">all_arrays</span><span class="p">,</span> <span class="n">percentiles</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">vmax</span> <span class="o">=</span> <span class="n">mlab</span><span class="o">.</span><span class="n">prctile</span><span class="p">(</span>
                <span class="n">all_arrays</span><span class="p">,</span> <span class="n">percentiles</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">vmin</span> <span class="o">=</span> <span class="n">all_arrays</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="n">vmax</span> <span class="o">=</span> <span class="n">all_arrays</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">array_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>

    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s">&#39;independent&#39;</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">array_dict</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">v</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="s">&#39;__call__&#39;</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">sorted_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">array_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">group</span><span class="p">,</span> <span class="n">keys</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">sorted_keys</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>
            <span class="n">all_arrays</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">array_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">percentiles</span><span class="p">:</span>
                <span class="n">vmin</span> <span class="o">=</span> <span class="n">mlab</span><span class="o">.</span><span class="n">prctile</span><span class="p">(</span>
                    <span class="n">all_arrays</span><span class="p">,</span> <span class="n">percentiles</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">vmax</span> <span class="o">=</span> <span class="n">mlab</span><span class="o">.</span><span class="n">prctile</span><span class="p">(</span>
                    <span class="n">all_arrays</span><span class="p">,</span> <span class="n">percentiles</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">vmin</span> <span class="o">=</span> <span class="n">all_arrays</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                <span class="n">vmax</span> <span class="o">=</span> <span class="n">all_arrays</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">d</span>

</div>
<div class="viewcode-block" id="ci"><a class="viewcode-back" href="../../autodocs/metaseq.plotutils.ci.html#metaseq.plotutils.ci">[docs]</a><span class="k">def</span> <span class="nf">ci</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">conf</span><span class="o">=</span><span class="mf">0.95</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Column-wise confidence interval.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    arr : array-like</span>

<span class="sd">    conf : float</span>
<span class="sd">        Confidence interval</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    m : array</span>
<span class="sd">        column-wise mean</span>
<span class="sd">    lower : array</span>
<span class="sd">        lower column-wise confidence bound</span>
<span class="sd">    upper : array</span>
<span class="sd">        upper column-wise confidence bound</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
    <span class="n">se</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">se</span> <span class="o">*</span> <span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">_ppf</span><span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">conf</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">m</span><span class="p">,</span> <span class="n">m</span> <span class="o">-</span> <span class="n">h</span><span class="p">,</span> <span class="n">m</span> <span class="o">+</span> <span class="n">h</span>

</div>
<div class="viewcode-block" id="nice_log"><a class="viewcode-back" href="../../autodocs/metaseq.plotutils.nice_log.html#metaseq.plotutils.nice_log">[docs]</a><span class="k">def</span> <span class="nf">nice_log</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Uses a log scale but with negative numbers.</span>

<span class="sd">    :param x: NumPy array</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">neg</span> <span class="o">=</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span>
    <span class="n">xi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">xi</span><span class="p">[</span><span class="n">neg</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">xi</span><span class="p">[</span><span class="n">neg</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">xi</span>

</div>
<div class="viewcode-block" id="tip_zscores"><a class="viewcode-back" href="../../autodocs/metaseq.plotutils.tip_zscores.html#metaseq.plotutils.tip_zscores">[docs]</a><span class="k">def</span> <span class="nf">tip_zscores</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the &quot;target identification from profiles&quot; (TIP) zscores</span>
<span class="sd">    from Cheng et al. 2001, Bioinformatics 27(23):3221-3227.</span>

<span class="sd">    :param a: NumPy array, where each row is the signal for a feature.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">weighted</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="n">a</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="n">weighted</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">zscores</span> <span class="o">=</span> <span class="p">(</span><span class="n">scores</span> <span class="o">-</span> <span class="n">scores</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="n">scores</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">zscores</span>

</div>
<span class="k">def</span> <span class="nf">fdrcorrection</span><span class="p">(</span><span class="n">pvals</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s">&#39;indep&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    NOTE: This function was copied from</span>
<span class="sd">    statsmodels.sandbox.stats.multicomp.fdrcorrection0, from statsmodels</span>
<span class="sd">    version 0.5.0.</span>

<span class="sd">    This is to avoid requiring all of statsmodels to be a dependency for</span>
<span class="sd">    metaseq, just for this function.</span>




<span class="sd">    pvalue correction for false discovery rate</span>

<span class="sd">    This covers Benjamini/Hochberg for independent or positively correlated and</span>
<span class="sd">    Benjamini/Yekutieli for general or negatively correlated tests. Both are</span>
<span class="sd">    available in the function multipletests, as method=`fdr_bh`, resp.</span>
<span class="sd">    `fdr_by`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pvals : array_like</span>
<span class="sd">        set of p-values of the individual tests.</span>
<span class="sd">    alpha : float</span>
<span class="sd">        error rate</span>
<span class="sd">    method : {&#39;indep&#39;, &#39;negcorr&#39;)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    rejected : array, bool</span>
<span class="sd">        True if a hypothesis is rejected, False if not</span>
<span class="sd">    pvalue-corrected : array</span>
<span class="sd">        pvalues adjusted for multiple hypothesis testing to limit FDR</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>

<span class="sd">    If there is prior information on the fraction of true hypothesis, then</span>
<span class="sd">    alpha should be set to alpha * m/m_0 where m is the number of tests, given</span>
<span class="sd">    by the p-values, and m_0 is an estimate of the true hypothesis.  (see</span>
<span class="sd">    Benjamini, Krieger and Yekuteli)</span>

<span class="sd">    The two-step method of Benjamini, Krieger and Yekutiel that estimates the</span>
<span class="sd">    number of false hypotheses will be available (soon).</span>

<span class="sd">    Method names can be abbreviated to first letter, &#39;i&#39; or &#39;p&#39; for fdr_bh and</span>
<span class="sd">    &#39;n&#39; for fdr_by.</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">pvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pvals</span><span class="p">)</span>

    <span class="n">pvals_sortind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">pvals</span><span class="p">)</span>
    <span class="n">pvals_sorted</span> <span class="o">=</span> <span class="n">pvals</span><span class="p">[</span><span class="n">pvals_sortind</span><span class="p">]</span>
    <span class="n">sortrevind</span> <span class="o">=</span> <span class="n">pvals_sortind</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">method</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;i&#39;</span><span class="p">,</span> <span class="s">&#39;indep&#39;</span><span class="p">,</span> <span class="s">&#39;p&#39;</span><span class="p">,</span> <span class="s">&#39;poscorr&#39;</span><span class="p">]:</span>
        <span class="n">ecdffactor</span> <span class="o">=</span> <span class="n">_ecdf</span><span class="p">(</span><span class="n">pvals_sorted</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;n&#39;</span><span class="p">,</span> <span class="s">&#39;negcorr&#39;</span><span class="p">]:</span>
        <span class="n">cm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pvals_sorted</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>  <span class="c"># corrected this</span>
        <span class="n">ecdffactor</span> <span class="o">=</span> <span class="n">_ecdf</span><span class="p">(</span><span class="n">pvals_sorted</span><span class="p">)</span> <span class="o">/</span> <span class="n">cm</span>
<span class="c">#    elif method in [&#39;n&#39;, &#39;negcorr&#39;]:</span>
<span class="c">#        cm = np.sum(np.arange(len(pvals)))</span>
<span class="c">#        ecdffactor = ecdf(pvals_sorted)/cm</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;only indep and necorr implemented&#39;</span><span class="p">)</span>
    <span class="n">reject</span> <span class="o">=</span> <span class="n">pvals_sorted</span> <span class="o">&lt;=</span> <span class="n">ecdffactor</span><span class="o">*</span><span class="n">alpha</span>
    <span class="k">if</span> <span class="n">reject</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">rejectmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">reject</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">reject</span><span class="p">[:</span><span class="n">rejectmax</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="n">pvals_corrected_raw</span> <span class="o">=</span> <span class="n">pvals_sorted</span> <span class="o">/</span> <span class="n">ecdffactor</span>
    <span class="n">pvals_corrected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="o">.</span><span class="n">accumulate</span><span class="p">(</span><span class="n">pvals_corrected_raw</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">pvals_corrected</span><span class="p">[</span><span class="n">pvals_corrected</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">reject</span><span class="p">[</span><span class="n">sortrevind</span><span class="p">],</span> <span class="n">pvals_corrected</span><span class="p">[</span><span class="n">sortrevind</span><span class="p">]</span>


<div class="viewcode-block" id="tip_fdr"><a class="viewcode-back" href="../../autodocs/metaseq.plotutils.tip_fdr.html#metaseq.plotutils.tip_fdr">[docs]</a><span class="k">def</span> <span class="nf">tip_fdr</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns adjusted TIP p-values for a particular `alpha`.</span>

<span class="sd">    (see :func:`tip_zscores` for more info)</span>

<span class="sd">    :param a: NumPy array, where each row is the signal for a feature</span>
<span class="sd">    :param alpha: False discovery rate</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">zscores</span> <span class="o">=</span> <span class="n">tip_zscores</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">pvals</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">zscores</span><span class="p">)</span>
    <span class="n">rejected</span><span class="p">,</span> <span class="n">fdrs</span> <span class="o">=</span> <span class="n">fdrcorrection</span><span class="p">(</span><span class="n">pvals</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fdrs</span>

</div>
<div class="viewcode-block" id="prepare_logged"><a class="viewcode-back" href="../../autodocs/metaseq.plotutils.prepare_logged.html#metaseq.plotutils.prepare_logged">[docs]</a><span class="k">def</span> <span class="nf">prepare_logged</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Transform `x` and `y` to a log scale while dealing with zeros.</span>

<span class="sd">    This function scales `x` and `y` such that the points that are zero in one</span>
<span class="sd">    array are set to the min of the other array.</span>

<span class="sd">    When plotting expression data, frequently one sample will have reads in</span>
<span class="sd">    a particular feature but the other sample will not.  Expression data also</span>
<span class="sd">    tends to look better on a log scale, but log(0) is undefined and therefore</span>
<span class="sd">    cannot be shown on a plot.  This function allows these points to be shown,</span>
<span class="sd">    piled up along one side of the plot.</span>

<span class="sd">    :param x,y: NumPy arrays</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">xi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">yi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

    <span class="n">xv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">xi</span><span class="p">)</span>
    <span class="n">yv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">yi</span><span class="p">)</span>

    <span class="n">global_min</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">xi</span><span class="p">[</span><span class="n">xv</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">yi</span><span class="p">[</span><span class="n">yv</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
    <span class="n">global_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">xi</span><span class="p">[</span><span class="n">xv</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">yi</span><span class="p">[</span><span class="n">yv</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

    <span class="n">xi</span><span class="p">[</span><span class="o">~</span><span class="n">xv</span><span class="p">]</span> <span class="o">=</span> <span class="n">global_min</span>
    <span class="n">yi</span><span class="p">[</span><span class="o">~</span><span class="n">yv</span><span class="p">]</span> <span class="o">=</span> <span class="n">global_min</span>

    <span class="k">return</span> <span class="n">xi</span><span class="p">,</span> <span class="n">yi</span>

</div>
<span class="k">def</span> <span class="nf">new_shell</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span> <span class="n">strip</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">height_ratios</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
              <span class="n">width_ratios</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">subplot_params</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">subplot_params</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">subplot_params</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
    <span class="n">gs</span> <span class="o">=</span> <span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">height_ratios</span><span class="p">),</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">width_ratios</span><span class="p">),</span>
        <span class="n">height_ratios</span><span class="o">=</span><span class="n">height_ratios</span><span class="p">,</span>
        <span class="n">width_ratios</span><span class="o">=</span><span class="n">width_ratios</span><span class="p">,</span>
        <span class="o">**</span><span class="n">subplot_params</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">array_axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">strip</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">strip_axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">sharey</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">array_axes</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">line_axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">sharex</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">array_axes</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">cax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">gs</span> <span class="o">=</span> <span class="n">gs</span>
    <span class="k">return</span> <span class="n">fig</span>


<div class="viewcode-block" id="matrix_and_line_shell"><a class="viewcode-back" href="../../autodocs/metaseq.plotutils.matrix_and_line_shell.html#metaseq.plotutils.matrix_and_line_shell">[docs]</a><span class="k">def</span> <span class="nf">matrix_and_line_shell</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span> <span class="n">strip</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper function to construct an empty figure that has space for a matrix,</span>
<span class="sd">    a summary line plot directly below it, a colorbar axis, and an optional</span>
<span class="sd">    &quot;strip&quot; axis that parallels the matrix (and shares its y-axis) where data</span>
<span class="sd">    can be added to create callbacks.</span>

<span class="sd">    Returns a tuple of (fig, matrix_ax, line_ax, strip_ax, colorbar_ax) that</span>
<span class="sd">    can then be used to plot upon.</span>

<span class="sd">    :param figsize: Tuple of (width, height), in inches, for the figure to be</span>
<span class="sd">    :param strip: If `strip` is False, then the returned `strip_ax` will be</span>
<span class="sd">        None and no strip axes will be created.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>

    <span class="c"># Constants to keep track</span>
    <span class="k">if</span> <span class="n">strip</span><span class="p">:</span>
        <span class="n">STRIP_COLS</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">STRIP_COLS</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ROWS</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">COLS</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">STRIP_COLS</span>
    <span class="n">MAT_COLS</span> <span class="o">=</span> <span class="mi">7</span>
    <span class="n">MAT_ROWS</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">LINE_ROWS</span> <span class="o">=</span> <span class="n">ROWS</span> <span class="o">-</span> <span class="n">MAT_ROWS</span>

    <span class="n">mat_ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">(</span>
        <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">ROWS</span><span class="p">,</span> <span class="n">COLS</span><span class="p">),</span>
        <span class="n">loc</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">STRIP_COLS</span><span class="p">),</span>
        <span class="n">rowspan</span><span class="o">=</span><span class="n">MAT_ROWS</span><span class="p">,</span>
        <span class="n">colspan</span><span class="o">=</span><span class="n">MAT_COLS</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">line_ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">(</span>
        <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">ROWS</span><span class="p">,</span> <span class="n">COLS</span><span class="p">),</span>
        <span class="n">loc</span><span class="o">=</span><span class="p">(</span><span class="n">MAT_ROWS</span><span class="p">,</span> <span class="n">STRIP_COLS</span><span class="p">),</span>
        <span class="n">rowspan</span><span class="o">=</span><span class="n">LINE_ROWS</span><span class="p">,</span>
        <span class="n">colspan</span><span class="o">=</span><span class="n">MAT_COLS</span><span class="p">,</span>
        <span class="n">sharex</span><span class="o">=</span><span class="n">mat_ax</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">strip</span><span class="p">:</span>
        <span class="n">strip_ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">(</span>
            <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">ROWS</span><span class="p">,</span> <span class="n">COLS</span><span class="p">),</span>
            <span class="n">loc</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="n">rowspan</span><span class="o">=</span><span class="n">MAT_ROWS</span><span class="p">,</span>
            <span class="n">colspan</span><span class="o">=</span><span class="n">STRIP_COLS</span><span class="p">,</span>
            <span class="n">sharey</span><span class="o">=</span><span class="n">mat_ax</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">strip_ax</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="n">cax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">(</span>
        <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">ROWS</span><span class="p">,</span> <span class="n">COLS</span><span class="p">),</span>
        <span class="n">loc</span><span class="o">=</span><span class="p">(</span><span class="n">ROWS</span> <span class="o">-</span> <span class="n">MAT_ROWS</span><span class="p">,</span> <span class="n">MAT_COLS</span> <span class="o">+</span> <span class="n">STRIP_COLS</span><span class="p">),</span>
        <span class="n">rowspan</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">colspan</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.88</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="mf">0.23</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">mat_ax</span><span class="p">,</span> <span class="n">line_ax</span><span class="p">,</span> <span class="n">strip_ax</span><span class="p">,</span> <span class="n">cax</span>

</div>
<div class="viewcode-block" id="clustered_sortind"><a class="viewcode-back" href="../../autodocs/metaseq.plotutils.clustered_sortind.html#metaseq.plotutils.clustered_sortind">[docs]</a><span class="k">def</span> <span class="nf">clustered_sortind</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">scorefunc</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Uses MiniBatch k-means clustering to cluster matrix into groups.</span>

<span class="sd">    Each cluster of rows is then sorted by `scorefunc` -- by default, the max</span>
<span class="sd">    peak height when all rows in a cluster are averaged, or</span>
<span class="sd">    cluster.mean(axis=0).max().</span>

<span class="sd">    Returns the index that will sort the rows of `x` and a list of &quot;breaks&quot;.</span>
<span class="sd">    `breaks` is essentially a cumulative row count for each cluster boundary.</span>
<span class="sd">    In other words, after plotting the array you can use axhline on each</span>
<span class="sd">    &quot;break&quot; to plot the cluster boundary.</span>

<span class="sd">    If `k` is a list or tuple, iteratively try each one and select the best</span>
<span class="sd">    with the lowest mean distance from cluster centers.</span>

<span class="sd">    :param x: Matrix whose rows are to be clustered</span>
<span class="sd">    :param k: Number of clusters to create or a list of potential clusters; the</span>
<span class="sd">        optimum will be chosen from the list</span>
<span class="sd">    :param scorefunc: Optional function for sorting rows within clusters.  Must</span>
<span class="sd">        accept a single argument of a NumPy array.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">sklearn.cluster</span> <span class="kn">import</span> <span class="n">MiniBatchKMeans</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s">&#39;please install scikits.learn for &#39;</span>
                          <span class="s">&#39;clustering.&#39;</span><span class="p">)</span>

    <span class="c"># If integer, do it once and we&#39;re done</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">best_k</span> <span class="o">=</span> <span class="n">k</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">mean_dists</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">_k</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
            <span class="n">mbk</span> <span class="o">=</span> <span class="n">MiniBatchKMeans</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="s">&#39;k-means++&#39;</span><span class="p">,</span> <span class="n">n_clusters</span><span class="o">=</span><span class="n">_k</span><span class="p">)</span>
            <span class="n">mbk</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">mean_dists</span><span class="p">[</span><span class="n">_k</span><span class="p">]</span> <span class="o">=</span> <span class="n">mbk</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">best_k</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">mean_dists</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">mbk</span> <span class="o">=</span> <span class="n">MiniBatchKMeans</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="s">&#39;k-means++&#39;</span><span class="p">,</span> <span class="n">n_clusters</span><span class="o">=</span><span class="n">best_k</span><span class="p">)</span>
    <span class="n">mbk</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">best_k</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">mbk</span><span class="o">.</span><span class="n">labels_</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">scorefunc</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">scorefunc</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">labels</span> <span class="o">==</span> <span class="n">label</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">scorefunc</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span> <span class="p">:])</span>
        <span class="n">scores</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">score</span>

    <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">breaks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">ind</span><span class="p">]):</span>
        <span class="n">pos</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">g</span><span class="p">))</span>
        <span class="n">breaks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ind</span><span class="p">,</span> <span class="n">breaks</span>

</div>
<span class="k">def</span> <span class="nf">new_clustered_sortind</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">row_key</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">cluster_key</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Uses MiniBatch k-means clustering to cluster matrix into groups.</span>

<span class="sd">    Each cluster of rows is then sorted by `scorefunc` -- by default, the max</span>
<span class="sd">    peak height when all rows in a cluster are averaged, or</span>
<span class="sd">    cluster.mean(axis=0).max().</span>

<span class="sd">    Returns the index that will sort the rows of `x` and a list of &quot;breaks&quot;.</span>
<span class="sd">    `breaks` is essentially a cumulative row count for each cluster boundary.</span>
<span class="sd">    In other words, after plotting the array you can use axhline on each</span>
<span class="sd">    &quot;break&quot; to plot the cluster boundary.</span>

<span class="sd">    If `k` is a list or tuple, iteratively try each one and select the best</span>
<span class="sd">    with the lowest mean distance from cluster centers.</span>

<span class="sd">    :param x: Matrix whose rows are to be clustered</span>
<span class="sd">    :param k: Number of clusters to create or a list of potential clusters; the</span>
<span class="sd">        optimum will be chosen from the list</span>
<span class="sd">    :param row_key:</span>
<span class="sd">        Optional function to act as a sort key for sorting rows within</span>
<span class="sd">        clusters.  Signature should be `scorefunc(a)` where `a` is a 1-D NumPy</span>
<span class="sd">        array.</span>
<span class="sd">    :param cluster_key:</span>
<span class="sd">        Optional function for sorting clusters.  Signature is `clusterfunc(a)`</span>
<span class="sd">        where `a` is a NumPy array containing all rows of `x` for cluster `i`.</span>
<span class="sd">        It must return a single value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">sklearn.cluster</span> <span class="kn">import</span> <span class="n">MiniBatchKMeans</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s">&#39;please install scikits.learn for &#39;</span>
                          <span class="s">&#39;clustering.&#39;</span><span class="p">)</span>

    <span class="c"># If integer, do it once and we&#39;re done</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">best_k</span> <span class="o">=</span> <span class="n">k</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">mean_dists</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">_k</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
            <span class="n">mbk</span> <span class="o">=</span> <span class="n">MiniBatchKMeans</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="s">&#39;k-means++&#39;</span><span class="p">,</span> <span class="n">n_clusters</span><span class="o">=</span><span class="n">_k</span><span class="p">)</span>
            <span class="n">mbk</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">mean_dists</span><span class="p">[</span><span class="n">_k</span><span class="p">]</span> <span class="o">=</span> <span class="n">mbk</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">best_k</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">mean_dists</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">mbk</span> <span class="o">=</span> <span class="n">MiniBatchKMeans</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="s">&#39;k-means++&#39;</span><span class="p">,</span> <span class="n">n_clusters</span><span class="o">=</span><span class="n">best_k</span><span class="p">)</span>
    <span class="n">mbk</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">best_k</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">mbk</span><span class="o">.</span><span class="n">labels_</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">cluster_key</span><span class="p">:</span>
        <span class="c"># It&#39;s easier for calling code to provide something that operates on</span>
        <span class="c"># a cluster level, but here it&#39;s converted to work on a label level</span>
        <span class="c"># that looks in to the array `x`.</span>
        <span class="k">def</span> <span class="nf">_cluster_key</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">cluster_key</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">labels</span> <span class="o">==</span> <span class="n">i</span><span class="p">,</span> <span class="p">:])</span>
        <span class="n">sorted_labels</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="n">_cluster_key</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c"># Otherwise just use them as-is.</span>
        <span class="n">sorted_labels</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">row_key</span><span class="p">:</span>
        <span class="c"># Again, easier to provide a function to operate on a row.  But here we</span>
        <span class="c"># need it to accept an index</span>
        <span class="k">def</span> <span class="nf">_row_key</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">row_key</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:])</span>

    <span class="n">final_ind</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">breaks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">sorted_labels</span><span class="p">:</span>
        <span class="c"># which rows in `x` have this label</span>
        <span class="n">label_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">labels</span> <span class="o">==</span> <span class="n">label</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">row_key</span><span class="p">:</span>
            <span class="n">label_sort_ind</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">label_inds</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">_row_key</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">label_sort_ind</span> <span class="o">=</span> <span class="n">label_inds</span>
        <span class="k">for</span> <span class="n">li</span> <span class="ow">in</span> <span class="n">label_sort_ind</span><span class="p">:</span>
            <span class="n">final_ind</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">li</span><span class="p">)</span>
        <span class="n">pos</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">label_inds</span><span class="p">)</span>
        <span class="n">breaks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">final_ind</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">breaks</span><span class="p">)</span>


<div class="viewcode-block" id="input_ip_plots"><a class="viewcode-back" href="../../autodocs/metaseq.plotutils.input_ip_plots.html#metaseq.plotutils.input_ip_plots">[docs]</a><span class="k">def</span> <span class="nf">input_ip_plots</span><span class="p">(</span><span class="n">iparr</span><span class="p">,</span> <span class="n">inputarr</span><span class="p">,</span> <span class="n">diffed</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">sort_ind</span><span class="p">,</span>
                   <span class="n">prefix</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">limits1</span><span class="o">=</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="n">limits2</span><span class="o">=</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                   <span class="n">hlines</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">vlines</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    All-in-one plotting function to make a 5-panel figure.</span>

<span class="sd">    Panels are IP, input, and diffed; plus 2 line plots showing averages.</span>

<span class="sd">    :param iparr, inputarr: NumPy arrays constructed by a genomic_signal object</span>
<span class="sd">    :param diffed: Difference of `iparr` and `inputarr`, but can be some other</span>
<span class="sd">                   transformation.</span>
<span class="sd">    :param x: Extent to use -- for TSSs, maybe something like</span>
<span class="sd">        np.linspace(-1000, 1000, bins), or for just bin IDs, something like</span>
<span class="sd">        `np.arange(bins)`.</span>

<span class="sd">    :param sort_ind: row order for each of the 3 panels -- usually interesting</span>
<span class="sd">        to use `clustered_sortind` or `tip_zscores`</span>

<span class="sd">    :param prefix: Used to prefix plot titles with &#39;%(prefix)s IP&quot;, etc</span>
<span class="sd">    :param limits1: Tuple passed to the Normalize function for IP and input.</span>
<span class="sd">    :param limits2: Tuple passed tot he Normalize function for the diffed array</span>
<span class="sd">    :param hlines: List of (position, kwarg) tuples for plotting horizontal</span>
<span class="sd">        lines.  Kwargs are passed directly to axhline. Useful for delimiting</span>
<span class="sd">        clusters, if you used `clustered_sortind` and have both `row_order` and</span>
<span class="sd">        `breaks`.</span>
<span class="sd">    :param vlines: List of (position, kwargs) tuples.  A vertical line will be</span>
<span class="sd">        plotted at each position using kwargs.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c"># global min and max</span>
    <span class="n">gmin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">iparr</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">inputarr</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
    <span class="n">gmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">iparr</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">inputarr</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

    <span class="c"># 3 arrays, 2 line plots, a gene strip, and 2 colorbars.  Plots share the</span>
    <span class="c"># axes that make sense</span>
    <span class="c">#</span>
    <span class="c"># 3 arrays</span>
    <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">(</span>
        <span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">colspan</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">rowspan</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
    <span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">(</span>
        <span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">colspan</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">rowspan</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>
    <span class="n">ax3</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">(</span>
        <span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">colspan</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">rowspan</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>

    <span class="c"># 2 line plots</span>
    <span class="n">ax4</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">colspan</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">rowspan</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>
    <span class="n">ax5</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">colspan</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">rowspan</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>

    <span class="c"># 2 colorbars</span>
    <span class="n">cax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">rect</span><span class="o">=</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.025</span><span class="p">))</span>
    <span class="n">cax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">rect</span><span class="o">=</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.025</span><span class="p">))</span>

    <span class="c"># For nice imshow axes</span>
    <span class="n">extent</span> <span class="o">=</span> <span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">diffed</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">cm</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">gist_gray</span>
    <span class="n">cm</span><span class="o">.</span><span class="n">set_bad</span><span class="p">(</span><span class="s">&#39;k&#39;</span><span class="p">)</span>
    <span class="n">cm</span><span class="o">.</span><span class="n">set_over</span><span class="p">(</span><span class="s">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">cm</span><span class="o">.</span><span class="n">set_under</span><span class="p">(</span><span class="s">&#39;b&#39;</span><span class="p">)</span>

    <span class="n">limits1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">limits1</span><span class="p">)</span>
    <span class="n">limits2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">limits2</span><span class="p">)</span>

    <span class="n">all_base</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">iparr</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">inputarr</span><span class="o">.</span><span class="n">ravel</span><span class="p">()))</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">limits1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">limits1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mlab</span><span class="o">.</span><span class="n">prctile</span><span class="p">(</span>
            <span class="n">all_base</span><span class="p">,</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">all_base</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">limits1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">limits1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mlab</span><span class="o">.</span><span class="n">prctile</span><span class="p">(</span>
            <span class="n">all_base</span><span class="p">,</span> <span class="mi">100</span> <span class="o">-</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">all_base</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">limits2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">limits2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mlab</span><span class="o">.</span><span class="n">prctile</span><span class="p">(</span>
            <span class="n">diffed</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">all_base</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">limits2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">limits2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mlab</span><span class="o">.</span><span class="n">prctile</span><span class="p">(</span>
            <span class="n">diffed</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="mi">100</span> <span class="o">-</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">all_base</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>

    <span class="k">del</span> <span class="n">all_base</span>

    <span class="n">imshow_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">interpolation</span><span class="o">=</span><span class="s">&#39;nearest&#39;</span><span class="p">,</span>
        <span class="n">aspect</span><span class="o">=</span><span class="s">&#39;auto&#39;</span><span class="p">,</span>
        <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="p">,</span>
        <span class="n">norm</span><span class="o">=</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="o">*</span><span class="n">limits1</span><span class="p">),</span>
        <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span>
        <span class="n">origin</span><span class="o">=</span><span class="s">&#39;lower&#39;</span><span class="p">)</span>

    <span class="c"># modify kwargs for diffed (by changing the normalization)</span>
    <span class="n">diffed_kwargs</span> <span class="o">=</span> <span class="n">imshow_kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">diffed_kwargs</span><span class="p">[</span><span class="s">&#39;norm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="o">*</span><span class="n">limits2</span><span class="p">)</span>

    <span class="c"># IP</span>
    <span class="n">mappable1</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">iparr</span><span class="p">[</span><span class="n">sort_ind</span><span class="p">,</span> <span class="p">:],</span> <span class="o">**</span><span class="n">imshow_kwargs</span><span class="p">)</span>

    <span class="c"># input</span>
    <span class="n">mappable2</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">inputarr</span><span class="p">[</span><span class="n">sort_ind</span><span class="p">,</span> <span class="p">:],</span> <span class="o">**</span><span class="n">imshow_kwargs</span><span class="p">)</span>

    <span class="c"># diffed</span>
    <span class="n">mappable3</span> <span class="o">=</span> <span class="n">ax3</span><span class="o">.</span><span class="n">imshow</span><span class="p">((</span><span class="n">diffed</span><span class="p">)[</span><span class="n">sort_ind</span><span class="p">,</span> <span class="p">:],</span> <span class="o">**</span><span class="n">diffed_kwargs</span><span class="p">)</span>

    <span class="c"># IP and input line plot with vertical line</span>
    <span class="n">ax4</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">inputarr</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s">&#39;--&#39;</span><span class="p">,</span>
             <span class="n">label</span><span class="o">=</span><span class="s">&#39;input&#39;</span><span class="p">)</span>
    <span class="n">ax4</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">iparr</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;k&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;ip&#39;</span><span class="p">)</span>
    <span class="n">ax4</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s">&#39;:&#39;</span><span class="p">)</span>

    <span class="c"># Diffed line plot with vertical line</span>
    <span class="n">ax5</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">diffed</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="s">&#39;k&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;enrichment&#39;</span><span class="p">)</span>
    <span class="n">ax5</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s">&#39;:&#39;</span><span class="p">)</span>

    <span class="c"># Colorbars</span>
    <span class="n">cbar1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">mappable1</span><span class="p">,</span> <span class="n">cax1</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s">&#39;horizontal&#39;</span><span class="p">)</span>
    <span class="n">cbar2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">mappable3</span><span class="p">,</span> <span class="n">cax2</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s">&#39;horizontal&#39;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">(</span><span class="n">cax1</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">(</span><span class="n">cax2</span><span class="p">)</span>

    <span class="c"># labeling...</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">&#39;features&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">ax2</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">ax3</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">&#39;bp&#39;</span><span class="p">)</span>
    <span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">&#39;mean reads per million mapped reads&#39;</span><span class="p">)</span>
    <span class="n">ax5</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">&#39;bp&#39;</span><span class="p">)</span>
    <span class="n">cax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">&#39;Reads per million mapped reads&#39;</span><span class="p">)</span>
    <span class="n">cax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">&#39;Enrichment (RPMMR)&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">prefix</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> IP&#39;</span> <span class="o">%</span> <span class="n">prefix</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> input&#39;</span> <span class="o">%</span> <span class="n">prefix</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s">&#39;Difference&#39;</span><span class="p">)</span>

    <span class="c"># diffed line plot should have y ax on right</span>
    <span class="n">ax5</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s">&#39;right&#39;</span><span class="p">)</span>
    <span class="n">ax5</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_label_position</span><span class="p">(</span><span class="s">&#39;right&#39;</span><span class="p">)</span>
    <span class="n">ax5</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">&#39;enriched reads per million mapped reads&#39;</span><span class="p">)</span>

    <span class="c"># Legends</span>
    <span class="n">ax4</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s">&#39;best&#39;</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">ax5</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s">&#39;best&#39;</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="c"># Make sure everybody snaps to xmin/xmax</span>
    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">,</span> <span class="n">ax5</span><span class="p">]:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="n">xmin</span><span class="o">=</span><span class="n">extent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xmax</span><span class="o">=</span><span class="n">extent</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">hlines</span><span class="p">:</span>
        <span class="n">hlines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">vlines</span><span class="p">:</span>
        <span class="n">vlines</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">ax3</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">kwargs</span> <span class="ow">in</span> <span class="n">hlines</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">kwargs</span> <span class="ow">in</span> <span class="n">vlines</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fig</span>

</div>
<span class="k">def</span> <span class="nf">_updatecopy</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span> <span class="n">update_with</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">override</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update a copy of dest with source.  If `keys` is a list, then only update</span>
<span class="sd">    with those keys.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">orig</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">keys</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="n">update_with</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">update_with</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">d</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">override</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">update_with</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">d</span>


<span class="k">def</span> <span class="nf">_clean</span><span class="p">(</span><span class="n">z</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a version of z that only has finite values</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">z</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">z</span><span class="p">)]</span>


<div class="viewcode-block" id="MarginalHistScatter"><a class="viewcode-back" href="../../autodocs/metaseq.plotutils.MarginalHistScatter.html#metaseq.plotutils.MarginalHistScatter">[docs]</a><span class="k">class</span> <span class="nc">MarginalHistScatter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<div class="viewcode-block" id="MarginalHistScatter.__init__"><a class="viewcode-back" href="../../autodocs/metaseq.plotutils.MarginalHistScatter.html#metaseq.plotutils.MarginalHistScatter.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">hist_size</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Class to enable incremental appending of scatterplots, each of which</span>
<span class="sd">        generate additional marginal histograms.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scatter_ax</span> <span class="o">=</span> <span class="n">ax</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">figure</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scatter_ax</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">top_hists</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">right_hists</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hist_size</span> <span class="o">=</span> <span class="n">hist_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pad</span> <span class="o">=</span> <span class="n">pad</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xfirst_ax</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yfirst_ax</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c"># will hold histogram data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hxs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hys</span> <span class="o">=</span> <span class="p">[]</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">xmax</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">scatter_ax</span><span class="o">.</span><span class="n">dataLim</span><span class="o">.</span><span class="n">xmax</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ymax</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">scatter_ax</span><span class="o">.</span><span class="n">dataLim</span><span class="o">.</span><span class="n">ymax</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">xmin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">scatter_ax</span><span class="o">.</span><span class="n">dataLim</span><span class="o">.</span><span class="n">xmin</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ymin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">scatter_ax</span><span class="o">.</span><span class="n">dataLim</span><span class="o">.</span><span class="n">ymin</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">limits</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xmax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ymin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ymax</span><span class="p">)</span>

<div class="viewcode-block" id="MarginalHistScatter.append"><a class="viewcode-back" href="../../autodocs/metaseq.plotutils.MarginalHistScatter.html#metaseq.plotutils.MarginalHistScatter.append">[docs]</a>    <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">scatter_kwargs</span><span class="p">,</span> <span class="n">hist_kwargs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">xhist_kwargs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
               <span class="n">yhist_kwargs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">num_ticks</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">hist_share</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
               <span class="n">marginal_histograms</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a new scatter to self.scatter_ax as well as marginal histograms</span>
<span class="sd">        for the same data, borrowing addtional room from the axes.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        x, y : array-like</span>
<span class="sd">            Data to be plotted</span>

<span class="sd">        scatter_kwargs : dict</span>
<span class="sd">            Keyword arguments that are passed directly to scatter().</span>

<span class="sd">        hist_kwargs : dict</span>
<span class="sd">            Keyword arguments that are passed directly to hist(), for both the</span>
<span class="sd">            top and side histograms.</span>

<span class="sd">        xhist_kwargs, yhist_kwargs : dict</span>
<span class="sd">            Additional, margin-specific kwargs for the x or y histograms</span>
<span class="sd">            respectively.  These are used to update `hist_kwargs`</span>

<span class="sd">        num_ticks : int</span>
<span class="sd">            How many tick marks to use in each histogram&#39;s y-axis</span>

<span class="sd">        labels : array-like</span>
<span class="sd">            Optional NumPy array of labels that will be set on the collection</span>
<span class="sd">            so that they can be accessed by a callback function.</span>

<span class="sd">        hist_share : bool</span>
<span class="sd">            If True, then all histograms will share the same frequency axes.</span>
<span class="sd">            Useful for showing relative heights if you don&#39;t want to use the</span>
<span class="sd">            hist_kwarg `normed=True`</span>

<span class="sd">        marginal_histograms : bool</span>
<span class="sd">            Set to False in order to disable marginal histograms and just use</span>
<span class="sd">            as a normal scatterplot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">scatter_kwargs</span> <span class="o">=</span> <span class="n">scatter_kwargs</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">hist_kwargs</span> <span class="o">=</span> <span class="n">hist_kwargs</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">xhist_kwargs</span> <span class="o">=</span> <span class="n">xhist_kwargs</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">yhist_kwargs</span> <span class="o">=</span> <span class="n">yhist_kwargs</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">yhist_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">orientation</span><span class="o">=</span><span class="s">&#39;horizontal&#39;</span><span class="p">))</span>

        <span class="c"># Plot the scatter</span>
        <span class="n">coll</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scatter_ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">scatter_kwargs</span><span class="p">)</span>
        <span class="n">coll</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">marginal_histograms</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">xhk</span> <span class="o">=</span> <span class="n">_updatecopy</span><span class="p">(</span><span class="n">hist_kwargs</span><span class="p">,</span> <span class="n">xhist_kwargs</span><span class="p">)</span>
        <span class="n">yhk</span> <span class="o">=</span> <span class="n">_updatecopy</span><span class="p">(</span><span class="n">hist_kwargs</span><span class="p">,</span> <span class="n">yhist_kwargs</span><span class="p">)</span>

        <span class="n">axhistx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span>
            <span class="s">&#39;top&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hist_size</span><span class="p">,</span>
            <span class="n">pad</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pad</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scatter_ax</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">xfirst_ax</span><span class="p">)</span>

        <span class="n">axhisty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span>
            <span class="s">&#39;right&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hist_size</span><span class="p">,</span>
            <span class="n">pad</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pad</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scatter_ax</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">yfirst_ax</span><span class="p">)</span>

        <span class="n">axhistx</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span>
            <span class="n">MaxNLocator</span><span class="p">(</span><span class="n">nbins</span><span class="o">=</span><span class="n">num_ticks</span><span class="p">,</span> <span class="n">prune</span><span class="o">=</span><span class="s">&#39;both&#39;</span><span class="p">))</span>

        <span class="n">axhisty</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span>
            <span class="n">MaxNLocator</span><span class="p">(</span><span class="n">nbins</span><span class="o">=</span><span class="n">num_ticks</span><span class="p">,</span> <span class="n">prune</span><span class="o">=</span><span class="s">&#39;both&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">xfirst_ax</span> <span class="ow">and</span> <span class="n">hist_share</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">xfirst_ax</span> <span class="o">=</span> <span class="n">axhistx</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">yfirst_ax</span> <span class="ow">and</span> <span class="n">hist_share</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">yfirst_ax</span> <span class="o">=</span> <span class="n">axhisty</span>

        <span class="c"># Keep track of which axes are which, because looking into fig.axes</span>
        <span class="c"># list will get awkward....</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">top_hists</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">axhistx</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">right_hists</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">axhisty</span><span class="p">)</span>

        <span class="c"># Scatter will deal with NaN, but hist will not.  So clean the data</span>
        <span class="c"># here.</span>
        <span class="n">hx</span> <span class="o">=</span> <span class="n">_clean</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">hy</span> <span class="o">=</span> <span class="n">_clean</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hxs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hx</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hy</span><span class="p">)</span>

        <span class="c"># Only plot hists if there&#39;s valid data</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">_xhk</span> <span class="o">=</span> <span class="n">_updatecopy</span><span class="p">(</span><span class="n">orig</span><span class="o">=</span><span class="n">xhk</span><span class="p">,</span> <span class="n">update_with</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="p">[</span><span class="n">hx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">hx</span><span class="p">[</span><span class="mi">0</span><span class="p">]]),</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;bins&#39;</span><span class="p">])</span>
                <span class="n">axhistx</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">hx</span><span class="p">,</span> <span class="o">**</span><span class="n">_xhk</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">axhistx</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">hx</span><span class="p">,</span> <span class="o">**</span><span class="n">xhk</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hy</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hy</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">_yhk</span> <span class="o">=</span> <span class="n">_updatecopy</span><span class="p">(</span><span class="n">orig</span><span class="o">=</span><span class="n">yhk</span><span class="p">,</span> <span class="n">update_with</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="p">[</span><span class="n">hy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">hy</span><span class="p">[</span><span class="mi">0</span><span class="p">]]),</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;bins&#39;</span><span class="p">])</span>
                <span class="n">axhisty</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">hy</span><span class="p">,</span> <span class="o">**</span><span class="n">_yhk</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">axhisty</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">hy</span><span class="p">,</span> <span class="o">**</span><span class="n">yhk</span><span class="p">)</span>

        <span class="c"># Turn off unnecessary labels -- for these, use the scatter&#39;s axes</span>
        <span class="c"># labels</span>
        <span class="k">for</span> <span class="n">txt</span> <span class="ow">in</span> <span class="n">axhisty</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">()</span> <span class="o">+</span> <span class="n">axhistx</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">():</span>
            <span class="n">txt</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">txt</span> <span class="ow">in</span> <span class="n">axhisty</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">():</span>
            <span class="n">txt</span><span class="o">.</span><span class="n">set_rotation</span><span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MarginalHistScatter.add_legends"><a class="viewcode-back" href="../../autodocs/metaseq.plotutils.MarginalHistScatter.html#metaseq.plotutils.MarginalHistScatter.add_legends">[docs]</a>    <span class="k">def</span> <span class="nf">add_legends</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xhists</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">yhists</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">scatter</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add legends to axes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">axs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">xhists</span><span class="p">:</span>
            <span class="n">axs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hxs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">yhists</span><span class="p">:</span>
            <span class="n">axs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hys</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scatter</span><span class="p">:</span>
            <span class="n">axs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axs</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">metaseq 0.5.6 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
<div class="footer">
    &copy; Copyright 2015, Ryan Dale.
  Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.3.1.
  <br />Theme based on <a href="http://readthedocs.org/">Read The Docs</a>

</div>





  </body>
</html>